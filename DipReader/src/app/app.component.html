<div class="container">
  <div class="sidebar">
    <h3>Esplora DIP</h3>
    
    <!-- Pannello di Ricerca -->
    <div class="search-box">
      <input 
        type="text" 
        [(ngModel)]="searchName" 
        placeholder="Cerca nome file..." 
        (keyup.enter)="performSearch()" 
        class="search-input">
      
      <!-- Intestazione Filtri Globali -->
      <div class="filter-header">
        <span class="filter-title">üîç Filtri Globali</span>
        <span class="filter-info" title="I filtri si applicano a TUTTI i file in modo uniforme">‚ìò</span>
      </div>
      
      <!-- Riga Filtri Dinamica -->
      <div *ngFor="let filter of filters; let i = index" class="filter-row">
        <select [(ngModel)]="filter.key" class="filter-select">
          <option value="" disabled selected>Seleziona campo...</option>
          <optgroup *ngFor="let group of groupedFilterKeys" [label]="group.groupLabel">
            <option *ngFor="let opt of group.options" [value]="opt.value">{{ opt.label }}</option>
          </optgroup>
        </select>
        <input type="text" [(ngModel)]="filter.value" placeholder="Contiene..." class="filter-input">
        <button (click)="removeFilter(i)" class="btn-icon remove" title="Rimuovi filtro">√ó</button>
      </div>

      <!-- Azioni di Ricerca -->
      <div class="search-actions">
        <button (click)="addFilter()" class="btn-small">+ Filtro</button>
        <div class="right-actions">
          <button (click)="performSearch()" class="btn-primary">Cerca</button>
          <button *ngIf="isSearching" (click)="clearSearch()" class="btn-secondary">Reset</button>
        </div>
      </div>
    </div>

    <hr>
    <button (click)="downloadDb()" class="btn-debug">üíæ Scarica DB Debug</button>
    
    <!-- Template Ricorsivo per l'Albero -->
    <ng-template #recursiveList let-list>
      <ul>
        <li *ngFor="let node of list">
          <div (click)="handleNodeClick(node)" 
               [class.is-folder]="node.type === 'folder'"
               [class.is-file]="node.type === 'file'"
               [style.font-weight]="node === selectedFile ? 'bold' : 'normal'">
            <span *ngIf="node.type === 'folder'">{{ node.expanded ? 'üìÇ' : 'üìÅ' }}</span>
            <span *ngIf="node.type === 'file'">üìÑ</span>
            {{ node.name }}
          </div>
          <div *ngIf="node.type === 'folder' && node.expanded">
            <ng-container *ngTemplateOutlet="recursiveList; context:{ $implicit: node.children }"></ng-container>
          </div>
        </li>
      </ul>
    </ng-template>

    <!-- Visualizzazione Albero -->
    <ng-container *ngTemplateOutlet="recursiveList; context:{ $implicit: fileTree }"></ng-container>
  </div>

  <!-- Pannello Principale -->
  <div class="main">
    <div *ngIf="selectedFile; else noFile">
      <h2>{{ selectedFile.name }}</h2>
      
      <!-- Barra Azioni File -->
      <div class="file-actions">
        <button (click)="openFile(selectedFile)">Apri in Nuova Scheda</button>
        <button (click)="downloadFile(selectedFile)">Scarica File</button>
        <button (click)="checkIntegrity(selectedFile)">Verifica Integrit√†</button>
        
        <!-- Badge Stato Integrit√† -->
        <span *ngIf="integrityStatus === 'loading'" class="badge loading">Verifica in corso...</span>
        <span *ngIf="integrityStatus === 'valid'" class="badge success">‚úî Integro (SHA-256)</span>
        <span *ngIf="integrityStatus === 'invalid'" class="badge error">‚úñ Corrotto</span>
        
        <!-- Data Verifica -->
        <small *ngIf="integrityVerifiedAt" class="verification-time">
          Verificato: {{ formatDate(integrityVerifiedAt) }}
        </small>
      </div>
      
      <!-- Visualizzatore Metadati -->
      <app-metadata-viewer [logicalPath]="selectedFile.path"></app-metadata-viewer>
    </div>

    <!-- Messaggio Nessun File Selezionato -->
    <ng-template #noFile>
      <p>Seleziona un file dall'albero per visualizzarne i dettagli.</p>
    </ng-template>
  </div>
</div>
